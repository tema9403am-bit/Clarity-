import React, { useState, useEffect } from "react";
import "./App.css";
import * as nearAPI from "near-api-js";

function App() {
  const [activeTab, setActiveTab] = useState("where");
  const [wallet, setWallet] = useState(null);
  const [accountId, setAccountId] = useState("");

  // Инициализация NEAR при загрузке
  useEffect(() => {
    const initNear = async () => {
      const { connect, keyStores, WalletConnection } = nearAPI;

      const keyStore = new keyStores.BrowserLocalStorageKeyStore();
      const config = {
        networkId: "testnet",
        keyStore,
        nodeUrl: "https://rpc.testnet.near.org",
        walletUrl: "https://wallet.testnet.near.org",
        helperUrl: "https://helper.testnet.near.org",
      };

      const near = await connect(config);
      const walletConnection = new WalletConnection(near);

      setWallet(walletConnection);

      if (walletConnection.isSignedIn()) {
        setAccountId(walletConnection.getAccountId());
      }
    };

    initNear();
  }, []);

  // Обработчик подключения NEAR
  const handleConnectWallet = () => {
    if (!wallet) return;
    wallet.requestSignIn({
      contractId: "", // при необходимости добавим сюда контракт
    });
  };

  // Обработчик выхода
  const handleLogout = () => {
    if (!wallet) return;
    wallet.signOut();
    setAccountId("");
  };

  // Отображение контента вкладок
  const renderContent = () => {
    switch (activeTab) {
      case "where":
        return (
          <div className="content">
            <h2>Ты находишься внутри экосистемы Clarity Chain</h2>
            <p>Платформа прозрачной экономики и открытых экспериментов.</p>
          </div>
        );
      case "participate":
        return (
          <div className="content">
            <h2>Участвуй в эксперименте</h2>
            {accountId ? (
              <>
                <p>Ты подключен как: <b>{accountId}</b></p>
                <button className="connect-btn" onClick={handleLogout}>
                  Выйти
                </button>
              </>
            ) : (
              <>
                <p>Подключи NEAR кошелёк, чтобы начать участие.</p>
                <button className="connect-btn" onClick={handleConnectWallet}>
                  Подключить NEAR кошелёк
                </button>
              </>
            )}
          </div>
        );
      case "stats":
        return (
          <div className="content">
            <h2>Статистика</h2>
            <p>Здесь будет отображаться аналитика сети Clarity Chain.</p>
          </div>
        );
      default:
        return null;
    }
  };

  return (
    <div className="app">
      <header className="header">
        <nav className="nav">
          <button
            className={activeTab === "where" ? "active" : ""}
            onClick={() => setActiveTab("where")}
          >
            Где я?
          </button>
          <button
            className={activeTab === "participate" ? "active" : ""}
            onClick={() => setActiveTab("participate")}
          >
            Участвовать в эксперименте
          </button>
          <button
            className={activeTab === "stats" ? "active" : ""}
            onClick={() => setActiveTab("stats")}
          >
            Статистика
          </button>
        </nav>
      </header>

      <main className="main">{renderContent()}</main>
    </div>
  );
}

export default App;