<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clarity Chain</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0d0d0d;
      color: #f0f0f0;
      font-family: "Inter", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    #start-screen, #main-menu, #experiment-screen {
      text-align: center;
      display: none;
      width: 100%;
      max-width: 400px;
    }

    h1, h2 { margin-bottom: 20px; }

    button {
      display: block;
      margin: 10px auto;
      padding: 12px 22px;
      font-size: 16px;
      background: #1a1a1a;
      color: #f0f0f0;
      border: 1px solid #555;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover { background: #333; }

    #wallet-status, #payment-form {
      margin-top: 15px;
      font-size: 15px;
    }

    input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
      width: 80%;
      margin-top: 10px;
      text-align: center;
    }

    .hidden { display: none; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/near-api-js@1.1.0/dist/near-api-js.min.js"></script>
</head>
<body>
  <div id="start-screen">
    <h1>Clarity Chain</h1>
    <p>–ü–æ–≥—Ä—É–∑–∏—Å—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∫–∏</p>
    <button id="start-btn">–ù–∞—á–∞—Ç—å</button>
  </div>

  <div id="main-menu" class="hidden">
    <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <button id="where-btn">–ì–¥–µ —è?</button>
    <button id="participate-btn">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ</button>
    <button id="stats-btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  </div>

  <div id="experiment-screen" class="hidden">
    <h2>–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ</h2>
    <p>–ü–æ–¥–∫–ª—é—á–∏ —Å–≤–æ–π NEAR-–∫–æ—à–µ–ª–µ–∫, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ.</p>
    <button id="connect-wallet-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
    <div id="wallet-status"></div>

    <div id="payment-form" class="hidden">
      <p>–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —É—á–∞—Å—Ç–∏—è (–≤ NEAR):</p>
      <input type="number" id="amount" placeholder="0.1" step="0.01" min="0.01" />
      <button id="send-payment-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
      <div id="payment-status"></div>
    </div>

    <button id="back-btn">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    console.log("üîπ Clarity Chain –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...");

    async function safeInit() {
      try {
        const { connect, keyStores, WalletConnection, utils } = window.nearApi;
        console.log("‚úÖ NEAR SDK –∑–∞–≥—Ä—É–∂–µ–Ω");

        const nearConfig = {
          networkId: "testnet",
          keyStore: new keyStores.BrowserLocalStorageKeyStore(),
          nodeUrl: "https://rpc.testnet.near.org",
          walletUrl: "https://wallet.testnet.near.org",
          helperUrl: "https://helper.testnet.near.org",
          explorerUrl: "https://explorer.testnet.near.org"
        };

        const near = await connect(nearConfig);
        const wallet = new WalletConnection(near);
        console.log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ —É—Å–ø–µ—à–Ω–æ");

        if (wallet.isSignedIn()) {
          document.getElementById("wallet-status").innerHTML = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: <b>${wallet.getAccountId()}</b>`;
          document.getElementById("payment-form").classList.remove("hidden");
          document.getElementById("connect-wallet-btn").textContent = "–û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫";
        }

        document.getElementById("connect-wallet-btn").onclick = () => {
          if (wallet.isSignedIn()) {
            wallet.signOut();
            window.location.reload();
          } else {
            wallet.requestSignIn();
          }
        };

        document.getElementById("send-payment-btn").onclick = async () => {
          const amount = parseFloat(document.getElementById("amount").value);
          const paymentStatus = document.getElementById("payment-status");

          if (!amount || amount <= 0) {
            paymentStatus.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.";
            return;
          }

          const yoctoAmount = utils.format.parseNearAmount(amount.toString());
          const receiver = "claritychain.testnet";

          try {
            paymentStatus.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
            await wallet.account().sendMoney(receiver, yoctoAmount);
            paymentStatus.innerHTML = `‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${amount} NEAR ‚Üí ${receiver}`;
          } catch (err) {
            console.error(err);
            paymentStatus.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ.";
          }
        };

      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ NEAR:", err);
        document.body.innerHTML = "<h3 style='color:red;text-align:center'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å.</h3>";
      }
    }

    // –ü–ª–∞–≤–Ω—ã–π –∑–∞–ø—É—Å–∫, —á—Ç–æ–±—ã Telegram —É—Å–ø–µ–ª –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
    window.addEventListener("load", () => {
      console.log("üì≤ Telegram Mini App –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω");
      document.getElementById("start-screen").style.display = "block";

      document.getElementById("start-btn").onclick = () => {
        document.getElementById("start-screen").classList.add("hidden");
        document.getElementById("main-menu").classList.remove("hidden");
      };

      document.getElementById("participate-btn").onclick = () => {
        document.getElementById("main-menu").classList.add("hidden");
        document.getElementById("experiment-screen").classList.remove("hidden");
      };

      document.getElementById("back-btn").onclick = () => {
        document.getElementById("experiment-screen").classList.add("hidden");
        document.getElementById("main-menu").classList.remove("hidden");
      };

      document.getElementById("where-btn").onclick = () =>
        alert("–¢—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ Clarity Chain ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞ –±—É–¥—É—â–µ–≥–æ.");

      document.getElementById("stats-btn").onclick = () =>
        alert("–†–∞–∑–¥–µ–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.");

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NEAR —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(safeInit, 1000);
    });
  </script>
</body>
</html>