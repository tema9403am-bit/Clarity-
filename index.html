<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEAR Experiment</title>
  <script src="https://unpkg.com/near-api-js/dist/near-api-js.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/client@1.8.0/dist/umd/index.min.js"></script>
  <style>
    body {
      background: black;
      color: white;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #00aaff;
    }
    button {
      background: #00aaff;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0088cc;
    }
    #error {
      color: gray;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Главное меню</h1>
  <button id="where">Где я?</button>
  <button id="experiment">Участвовать в эксперименте</button>
  <button id="stats">Статистика</button>
  <button id="connect">Подключить кошелёк</button>
  <p id="error"></p>

  <script>
    const { connect, keyStores, WalletConnection, transactions, utils } = nearApi;
    const CONTRACT_RECEIVER = "i6430499141.tg";
    let walletConnection;
    let near;
    let account;
    let wcConnector;

    async function initNear() {
      try {
        near = await connect({
          networkId: "mainnet",
          nodeUrl: "https://rpc.mainnet.near.org",
          walletUrl: "https://wallet.mainnet.near.org",
          keyStore: new keyStores.BrowserLocalStorageKeyStore(),
        });

        walletConnection = new WalletConnection(near);
        if (walletConnection.isSignedIn()) {
          account = walletConnection.account();
          document.getElementById("connect").innerText = "Кошелёк подключён";
        }
      } catch (e) {
        document.getElementById("error").innerText = "Ошибка: near-api-js не загружен";
        console.error(e);
      }
    }

    document.getElementById("connect").addEventListener("click", async () => {
      try {
        // Инициализация WalletConnect
        wcConnector = new window.WalletConnect.default({
          bridge: "https://bridge.walletconnect.org",
        });

        if (!wcConnector.connected) {
          await wcConnector.createSession();
        }

        wcConnector.on("connect", (error, payload) => {
          if (error) throw error;
          document.getElementById("connect").innerText = "Кошелёк подключён";
        });

        wcConnector.on("disconnect", () => {
          document.getElementById("connect").innerText = "Подключить кошелёк";
        });

      } catch (e) {
        document.getElementById("error").innerText = "Ошибка подключения WalletConnect";
        console.error(e);
      }
    });

    document.getElementById("experiment").addEventListener("click", async () => {
      try {
        if (!walletConnection || !walletConnection.isSignedIn()) {
          walletConnection.requestSignIn();
          return;
        }

        const amount = utils.format.parseNearAmount("0.01"); // 0.01 NEAR
        const tx = transactions.transfer(amount);

        await walletConnection.account().signAndSendTransaction({
          receiverId: CONTRACT_RECEIVER,
          actions: [tx],
        });

        alert("Транзакция успешно отправлена!");
      } catch (err) {
        document.getElementById("error").innerText = "Ошибка транзакции: " + err.message;
        console.error(err);
      }
    });

    document.getElementById("where").addEventListener("click", () => {
      alert("Вы в экспериментальном приложении NEAR.");
    });

    document.getElementById("stats").addEventListener("click", () => {
      alert("Пока статистика недоступна.");
    });

    initNear();
  </script>
</body>
</html>